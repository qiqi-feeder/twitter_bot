# Twitter OAuth 2.0 è®¤è¯å®ç°è¯´æ˜

## ğŸ“‹ å®ç°æ¦‚è¿°

æœ¬é¡¹ç›®å·²å®Œæ•´å®ç° Twitter OAuth 2.0 è®¤è¯æœºåˆ¶ï¼ŒåŒ…æ‹¬è‡ªåŠ¨ Token åˆ·æ–°ã€ä»£ç†æ”¯æŒå’Œå®Œæ•´çš„æˆæƒæµç¨‹ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. OAuth 2.0 Token ç®¡ç†å™¨ (`auth/token_manager.py`)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ä»é…ç½®æ–‡ä»¶åŠ è½½ access_token å’Œ refresh_token
- âœ… è‡ªåŠ¨æ£€æµ‹ Token è¿‡æœŸï¼ˆæå‰ 5 åˆ†é’Ÿåˆ·æ–°ï¼‰
- âœ… ä½¿ç”¨ refresh_token è‡ªåŠ¨åˆ·æ–° access_token
- âœ… å°†æ–° Token è‡ªåŠ¨ä¿å­˜å›é…ç½®æ–‡ä»¶
- âœ… æ”¯æŒ SOCKS5 ä»£ç†ï¼ˆæ‰€æœ‰è¯·æ±‚ï¼‰
- âœ… Token æ’¤é”€åŠŸèƒ½
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**å…³é”®æ–¹æ³•**:
```python
# è·å–è®¿é—®ä»¤ç‰Œï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰
access_token = token_manager.get_access_token()

# è·å–åˆ·æ–°ä»¤ç‰Œ
refresh_token = token_manager.get_refresh_token()

# éªŒè¯å‡­æ®
is_valid = token_manager.validate_credentials()

# è·å–è®¤è¯å¤´éƒ¨
headers = token_manager.get_auth_headers()

# æ’¤é”€ä»¤ç‰Œ
token_manager.revoke_token()
```

### 2. OAuth 2.0 å®¢æˆ·ç«¯ (`auth/oauth2_client.py`)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… å®Œæ•´çš„ OAuth 2.0 æˆæƒæµç¨‹
- âœ… PKCE (Proof Key for Code Exchange) æ”¯æŒ
- âœ… State å‚æ•°éªŒè¯ï¼ˆé˜²æ­¢ CSRF æ”»å‡»ï¼‰
- âœ… æˆæƒç äº¤æ¢è®¿é—®ä»¤ç‰Œ
- âœ… Token åˆ·æ–°
- âœ… Token æ’¤é”€
- âœ… ä»£ç†æ”¯æŒ

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from auth.oauth2_client import OAuth2Client

# åˆ›å»ºå®¢æˆ·ç«¯
client = OAuth2Client(
    client_id="your_client_id",
    client_secret="your_client_secret",
    redirect_uri="http://localhost:8080/callback",
    proxies=proxies
)

# è·å–æˆæƒ URL
auth_url = client.get_authorization_url(
    scopes=['tweet.read', 'tweet.write', 'users.read', 'offline.access']
)

# äº¤æ¢æˆæƒç 
token_data = client.exchange_code_for_token(authorization_code)

# åˆ·æ–°ä»¤ç‰Œ
new_token_data = client.refresh_access_token(refresh_token)
```

### 3. Twitter API å®¢æˆ·ç«¯æ›´æ–° (`twitter/api_client.py`)

**æ”¹è¿›**:
- âœ… ä¼˜å…ˆä½¿ç”¨ OAuth 2.0 è®¤è¯
- âœ… è‡ªåŠ¨æ£€æµ‹è®¤è¯æ–¹å¼ï¼ˆOAuth 2.0 æˆ– OAuth 1.0aï¼‰
- âœ… æ”¯æŒä»£ç†é…ç½®
- âœ… è‡ªåŠ¨ Token åˆ·æ–°

**è®¤è¯æ–¹å¼é€‰æ‹©**:
```python
# å¦‚æœé…ç½®äº† access_token å’Œ refresh_tokenï¼Œä½¿ç”¨ OAuth 2.0
if access_token and refresh_token:
    # OAuth 2.0 è®¤è¯
    client = tweepy.Client(bearer_token=access_token)
else:
    # å›é€€åˆ° OAuth 1.0a
    client = tweepy.Client(
        consumer_key=consumer_key,
        consumer_secret=consumer_secret,
        access_token=access_token,
        access_token_secret=access_token_secret
    )
```

### 4. æˆæƒå·¥å…· (`tools/oauth2_authorize.py`)

**åŠŸèƒ½**:
- âœ… äº¤äº’å¼ OAuth 2.0 æˆæƒæµç¨‹
- âœ… è‡ªåŠ¨å¯åŠ¨æœ¬åœ°å›è°ƒæœåŠ¡å™¨
- âœ… è‡ªåŠ¨äº¤æ¢æˆæƒç è·å– Token
- âœ… è‡ªåŠ¨ä¿å­˜ Token åˆ°é…ç½®æ–‡ä»¶
- âœ… æ”¯æŒä»£ç†

**ä½¿ç”¨æ–¹æ³•**:
```bash
python tools/oauth2_authorize.py
```

### 5. æµ‹è¯•å·¥å…·

#### å¿«é€Ÿæµ‹è¯• (`tools/quick_test.py`)
- âœ… æµ‹è¯•é…ç½®æ–‡ä»¶åŠ è½½
- âœ… æµ‹è¯• Token åŠ è½½
- âœ… æµ‹è¯•ä»£ç†é…ç½®
- âœ… æµ‹è¯•è®¤è¯å¤´éƒ¨ç”Ÿæˆ
- âœ… ä¸éœ€è¦ç½‘ç»œè¿æ¥

```bash
python tools/quick_test.py
```

#### å®Œæ•´æµ‹è¯• (`tools/test_oauth2.py`)
- âœ… æµ‹è¯• Token åˆ·æ–°
- âœ… æµ‹è¯•ä»£ç†è¿æ¥
- âœ… æµ‹è¯•ç½‘ç»œè¯·æ±‚
- âœ… å®Œæ•´çš„åŠŸèƒ½éªŒè¯

```bash
python tools/test_oauth2.py
```

### 6. é…ç½®æ–‡ä»¶æ›´æ–°

**config/config.yaml**:
```yaml
twitter:
  # OAuth 2.0 é…ç½®
  access_token: "your_access_token"
  refresh_token: "your_refresh_token"
  token_expires_at: "2024-12-31T23:59:59"
  client_id: "your_client_id"
  client_secret: "your_client_secret"
  
  # OAuth 1.0a é…ç½®ï¼ˆå…¼å®¹ï¼‰
  bearer_token: "..."
  consumer_key: "..."
  consumer_secret: "..."
  access_token_secret: "..."

proxy:
  socks5_url: "socks5://user:pass@host:port"
  enabled: true
```

## ğŸ”„ Token åˆ·æ–°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨è¯·æ±‚ access_token                   â”‚
â”‚  token_manager.get_access_token()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ                     â”‚
â”‚  _is_token_expired()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
         æ˜¯å¦è¿‡æœŸï¼Ÿ
          /    \
        æ˜¯      å¦
        â†“       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ·æ–°Token â”‚  â”‚ è¿”å›å½“å‰Token â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½¿ç”¨ refresh_token è¯·æ±‚æ–° Token         â”‚
â”‚  POST /2/oauth2/token                   â”‚
â”‚  - grant_type: refresh_token            â”‚
â”‚  - refresh_token: xxx                   â”‚
â”‚  - é€šè¿‡ SOCKS5 ä»£ç†                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ›´æ–°å†…å­˜ä¸­çš„ Token                      â”‚
â”‚  - access_token                         â”‚
â”‚  - refresh_token (å¦‚æœæœ‰æ–°çš„)            â”‚
â”‚  - token_expires_at                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿å­˜åˆ°é…ç½®æ–‡ä»¶                          â”‚
â”‚  _save_tokens_to_config()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›æ–°çš„ access_token                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸŒ ä»£ç†æ”¯æŒ

æ‰€æœ‰ OAuth 2.0 è¯·æ±‚éƒ½è‡ªåŠ¨ä½¿ç”¨é…ç½®çš„ SOCKS5 ä»£ç†ï¼š

1. **Token åˆ·æ–°è¯·æ±‚** â†’ é€šè¿‡ä»£ç†
2. **Token æ’¤é”€è¯·æ±‚** â†’ é€šè¿‡ä»£ç†
3. **æˆæƒç äº¤æ¢** â†’ é€šè¿‡ä»£ç†
4. **Twitter API è¯·æ±‚** â†’ é€šè¿‡ä»£ç†

## ğŸ“ ä½¿ç”¨æŒ‡å—

### æ–¹å¼ 1: ä½¿ç”¨æˆæƒå·¥å…·ï¼ˆæ¨èï¼‰

```bash
# 1. é…ç½® Client ID
# ç¼–è¾‘ config/config.yamlï¼Œå¡«å…¥ client_id

# 2. è¿è¡Œæˆæƒå·¥å…·
python tools/oauth2_authorize.py

# 3. åœ¨æµè§ˆå™¨ä¸­å®Œæˆæˆæƒ

# 4. Token è‡ªåŠ¨ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
```

### æ–¹å¼ 2: æ‰‹åŠ¨é…ç½®

å¦‚æœæ‚¨å·²æœ‰ access_token å’Œ refresh_tokenï¼š

```yaml
twitter:
  access_token: "your_access_token"
  refresh_token: "your_refresh_token"
```

### éªŒè¯é…ç½®

```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆä¸éœ€è¦ç½‘ç»œï¼‰
python tools/quick_test.py

# å®Œæ•´æµ‹è¯•ï¼ˆéœ€è¦ç½‘ç»œï¼‰
python tools/test_oauth2.py
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **PKCE æ”¯æŒ**: é˜²æ­¢æˆæƒç æ‹¦æˆªæ”»å‡»
2. **State éªŒè¯**: é˜²æ­¢ CSRF æ”»å‡»
3. **Token æŒä¹…åŒ–**: å®‰å…¨ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
4. **è‡ªåŠ¨åˆ·æ–°**: Token è¿‡æœŸå‰è‡ªåŠ¨åˆ·æ–°
5. **ä»£ç†æ”¯æŒ**: æ‰€æœ‰è¯·æ±‚é€šè¿‡ä»£ç†ï¼Œä¿æŠ¤éšç§

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [OAuth 2.0 è®¤è¯æŒ‡å—](OAUTH2_GUIDE.md) - è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- [Twitter OAuth 2.0 æ–‡æ¡£](https://developer.twitter.com/en/docs/authentication/oauth-2-0)

## ğŸ¯ ä¸‹ä¸€æ­¥

ç°åœ¨æ‚¨å¯ä»¥ï¼š

1. âœ… è¿è¡Œå¿«é€Ÿæµ‹è¯•éªŒè¯é…ç½®
2. âœ… ä½¿ç”¨æˆæƒå·¥å…·è·å– Tokenï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
3. âœ… å¯åŠ¨åº”ç”¨å¼€å§‹è‡ªåŠ¨å‘æ¨

```bash
python app.py
```

